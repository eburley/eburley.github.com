<!DOCTYPE html>
<html>

  <head>
    <meta charset='utf-8' />
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <meta name="description" content="eburley.github.com : code and stuff" />

    <link rel="stylesheet" type="text/css" media="screen" href="stylesheets/stylesheet.css">

    <title>eburley.github.com</title>
  </head>

  <body>

    <!-- HEADER -->
    <div id="header_wrap" class="outer">
        <header class="inner">
          <a id="forkme_banner" href="https://github.com/eburley">View on GitHub</a>

          <h1 id="project_title">eburley.github.com</h1>
          <h2 id="project_tagline">code and stuff</h2>

        </header>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main_content_wrap" class="outer">
      <section id="main_content" class="inner">
        <h1>
<a href="http://angularjs.org">angularjs.org</a>, $watch, $event, $on, $emit - what to use when</h1>

<p>A team I work on has been using Angular's various watch and event systems for more than half a year now, and I wanted to put out some best practices that we've learned from painful experience.</p>

<h3>When to use a watch:</h3>

<ul>
<li>when you're writing a directive and want data binding behavior</li>
<li>when you're watching a stateful service </li>
<li>when it's OK for the ui and state update to happen in a non-deterministic order</li>
</ul><h3>When NOT to use a watch:</h3>

<ul>
<li>when you need to orchestrate complicated data loading patterns</li>
<li>when you're watching the routeParams.</li>
</ul><h2>Best practices around watches:</h2>

<ul>
<li><p>check for newValue !== oldValue in the watch callback.  Watch callbacks are always called at least once.
watch functions, not properties.  You can't set breakpoints on properties</p></li>
<li><p>if your watcher function looks like this:</p></li>
</ul><div class="highlight"><pre><span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span><span class="k">return</span> <span class="nx">SomeService</span><span class="p">.</span><span class="nx">stateValueGetter</span><span class="p">()},</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span><span class="nx">oldValue</span><span class="p">){});</span>
</pre></div>

<p>just do this:</p>

<div class="highlight"><pre><span class="nx">$scope</span><span class="p">.</span><span class="nx">$watch</span><span class="p">(</span><span class="nx">SomeService</span><span class="p">.</span><span class="nx">stateValueGetter</span><span class="p">,</span>
    <span class="kd">function</span><span class="p">(</span><span class="nx">newValue</span><span class="p">,</span><span class="nx">oldValue</span><span class="p">){});</span>
</pre></div>

<h3>When to use pub/sub:</h3>

<ul>
<li>when you need to let multiple subscribers know about an event and those subscribers need to do more than radiate information to their view.</li>
</ul><h3>When NOT to use pub/sub:</h3>

<ul>
<li>when you're watching a simple state based service and using that to update a view.</li>
<li>when you're writing a general purpose directive and need data binding.</li>
</ul><h2>Best practices around pub/sub:</h2>

<ul>
<li>encapsulate subject-specific watches using the following pattern:</li>
</ul><div class="highlight"><pre><span class="c1">// an example channel service that lets consumers</span>
<span class="c1">// subscribe and publish for nuclear reactor meltdowns</span>

<span class="kd">var</span> <span class="nx">CoreReactorChannel</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$rootScope</span><span class="p">)</span> <span class="p">{</span>

    <span class="c1">// local constants for the message ids.  </span>
    <span class="c1">// these are private implementation detail</span>
    <span class="kd">var</span> <span class="nx">ELEVATED_CORE_TEMPERATURE_MESSAGE</span> <span class="o">=</span> <span class="s2">"elevatedCoreMessage"</span><span class="p">;</span>

    <span class="c1">// publish elevatedCoreTemperature</span>
    <span class="c1">// note that the parameters are particular to the problem domain</span>
    <span class="kd">var</span> <span class="nx">elevatedCoreTemperature</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">core_id</span><span class="p">,</span> <span class="nx">temperature</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$rootScope</span><span class="p">.</span><span class="nx">$broadcast</span><span class="p">(</span><span class="nx">ELEVATED_CORE_TEMPERATURE_MESSAGE</span><span class="p">,</span>
            <span class="p">{</span>
                <span class="nx">core_id</span><span class="o">:</span> <span class="nx">core_id</span><span class="p">,</span>
                <span class="nx">temperature</span><span class="o">:</span> <span class="nx">temperature</span>
            <span class="p">});</span>
    <span class="p">};</span>

    <span class="c1">// subscribe to elevatedCoreTemperature event.</span>
    <span class="c1">// note that you should require $scope first </span>
    <span class="c1">// so that when the subscriber is destroyed you </span>
    <span class="c1">// don't create a closure over it, and te scope can clean up. </span>
    <span class="kd">var</span> <span class="nx">onElevatedCoreTemperature</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">handler</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$scope</span><span class="p">.</span><span class="nx">$on</span><span class="p">(</span><span class="nx">ELEVATED_CORE_TEMPERATURE_MESSAGE</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">event</span><span class="p">,</span> <span class="nx">message</span><span class="p">){</span>
            <span class="c1">// note that the handler is passed the problem domain parameters </span>
            <span class="nx">handler</span><span class="p">(</span><span class="nx">core_id</span><span class="p">,</span> <span class="nx">temperature</span><span class="p">);</span>
        <span class="p">});</span>
    <span class="p">};</span>

    <span class="c1">// other CoreReactorChannel events would go here.</span>

    <span class="k">return</span> <span class="p">{</span>
        <span class="nx">elevatedCoreTemperature</span><span class="o">:</span> <span class="nx">elevatedCoreTemperature</span><span class="p">,</span>
        <span class="nx">onElevatedCoreTemperature</span><span class="o">:</span> <span class="nx">onElevatedCoreTemperature</span>
    <span class="p">};</span>
<span class="p">};</span>


<span class="c1">//Usage elsewhere in the application</span>
<span class="kd">var</span> <span class="nx">MyController</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">CoreReactorChannel</span><span class="p">){</span>
    <span class="c1">// Handle core temperature changes</span>
    <span class="kd">var</span> <span class="nx">onCoreTemperatureChange</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">){</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="nx">message</span><span class="p">.</span><span class="nx">core_id</span><span class="p">,</span> <span class="nx">message</span><span class="p">.</span><span class="nx">temperature</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Let the CoreReactorChannel know the temperature has changed</span>
    <span class="nx">$scope</span><span class="p">.</span><span class="nx">changeTemperature</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(</span><span class="nx">core_id</span><span class="p">,</span> <span class="nx">temperature</span><span class="p">){</span>
        <span class="nx">CoreReactorChannel</span><span class="p">.</span><span class="nx">elevatedCoreTemperature</span><span class="p">(</span><span class="nx">core_id</span><span class="p">,</span> <span class="nx">temperature</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="c1">// Listen for temperature changes and call a handler</span>
    <span class="c1">// Note: The handler can be an inline function</span>
    <span class="nx">CoreReactorChannel</span><span class="p">.</span><span class="nx">onElevatedCoreTemperature</span><span class="p">(</span><span class="nx">$scope</span><span class="p">,</span> <span class="nx">onCoreTemperatureChange</span><span class="p">);</span>
<span class="p">};</span>   
</pre></div>

<ul>
<li>don't mix concerns in the channel code.  A general channel is a ball of mud.</li>
</ul><hr><h1>I did a presentation:</h1>

<ul>
<li>the <a href="http://vimeo.com/57296465">slides</a>
</li>
<li>the <a href="https://github.com/eburley/jasmine.presentation">code</a>
</li>
</ul>
      </section>
    </div>

    <!-- FOOTER  -->
    <div id="footer_wrap" class="outer">
      <footer class="inner">
        <p>Published with <a href="http://pages.github.com">GitHub Pages</a></p>
      </footer>
    </div>

    

  </body>
</html>
